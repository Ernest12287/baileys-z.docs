<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Baileys-z-Initialization</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" href="../images/social_card.jpeg" type="image/x-icon">
        <link rel="stylesheet" href="../styles/initialize.css">
    </head>
    <body>
        <!-- Header Image -->
        <div class="header-image">
            <img src="../images/social_card.jpeg" alt="Baileys-z Logo">
        </div>

        <main class="content">
            <h1>Initialization of the Packages We Just Installed</h1>
            <p>
                Well, here is the very complicated part as it will define how your bot will work and on what conditions.
            </p>

            <hr>

            <h2>Required Setup Check</h2>
            <p>First, let's ensure that you have the required applications ready to go:</p>
            <ol>
                <li>
                    <strong>VS Code</strong>: Any modern version is acceptable.
                </li>
                <li>
                    <strong>WhatsApp on your phone</strong>: The latest version is highly recommended. This is basically the main tool for authentication.
                </li>
            </ol>

            <hr>

            <h2>‚ö†Ô∏è Important Precautions Before You Start</h2>
            <p>Before we start, there are some precautions you should take note of:</p>
            <ol>
                <li>
                    <strong>Unofficial API & Ban Risk:</strong> Baileys-z and Baileys are in no way affiliated with WhatsApp. It is an unofficial way to automate WhatsApp, so if done aggressively, WhatsApp <strong>will ban your account</strong>. This will not be our fault. Not to worry, we will provide guidance in this documentation to prevent this.
                </li>
                <li>
                    <strong>Service Breaks and Updates:</strong> Sometimes WhatsApp might update its website code selectors, internal protocols, or introduce more security features. This might lead to the library crashing or, at terrible times, an auto-logout. This is not our fault. We will immediately update our library, and you just need to update your project dependencies with <code>npm update</code> and reconnect the library.
                </li>
                <li>
                    <strong>Unpredictable Failures:</strong> At times, WhatsApp might just decide to change something that we, as developers, do not know about. For example, the most culprit is the <strong>request paircode function</strong> (we will talk about it soon enough). It might work perfectly at 7:00 AM and fail at 7:05 AM. This is not our fault, and we do not know what causes such immediate failures, but we will provide solutions for handling such errors.
                </li>
            </ol>
            <p>
                Making a WhatsApp bot is super fun and joyful. Trust me, guys, you will love it and also be proud of yourselves!
            </p>

            <hr>

            <h2>Project Folder Structure</h2>
            <p>
                Okay, so the first thing to highly consider is the <strong>folder structure</strong>. A clean structure is vital for scaling your bot.
            </p>
            
            <h3>Must-Have Files & Folders:</h3>
            <ol>
                <li>
                    <strong><code>index.js</code></strong>: This will be our main file, the <strong>mother of all code</strong>, responsible for booting the application and managing the core connection state.
                </li>
                <li>
                    <strong><code>logger.js</code></strong>: This will be our logger file that will help us initialize the <strong><code>ernest-logger</code></strong> and export it for use in all our files.
                </li>
                <li>
                    <strong><code>config.js</code></strong>: I call this file your backup environment file, as this file will contain the default environment configs, also exported.
                </li>
                <li>
                    <strong><code>commands/plugin/features</code> folder</strong>: This folder will contain your command files, separating bot logic into modular chunks.
                </li>
                <li>
                    <strong><code>handlers</code> folder</strong>: This folder will contain the main handlers of your bot, like the <strong>message handler</strong> and connection event handling.
                </li>
            </ol>

            <hr>

            <h2>The Core Connection Code: <code>index.js</code></h2>
            <p>
                This section provides the basic template for connecting to WhatsApp, handling the connection state, and saving your authentication session.
            </p>

            <p>
                <strong>How to Copy Code:</strong> Below is the code block. You can manually copy the text, or use the "Copy Code" button.
            </p>

            <div class="code-container">
                <button onclick="copyCode('connectionCode')">Copy Code</button>
                <pre><code id="connectionCode">// index.js - The Main Entry Point

// 1. Import required functions and constants from Baileys-z
import makeWASocket, {
    useMultiFileAuthState,
    fetchLatestBaileysVersion,
    DisconnectReason
} from 'baileys-z';

// 2. Import error handling utility (from official Baileys dependency)
import { Boom } from '@hapi/boom';

// 3. Import Ernest Tech House Logger (assuming you export it from logger.js)
import logger from './logger.js'; 

// The main connection function
async function startBaileysBot() {
    // Load authentication state (creates the 'auth_info_baileys' folder)
    const { state, saveCreds } = await useMultiFileAuthState('auth_info_baileys');

    // Fetch the latest WhatsApp version recommended by Baileys
    const { version, isLatest } = await fetchLatestBaileysVersion();
    logger.info(`Using WhatsApp version: ${version.join('.')}, is latest: ${isLatest}`);

    // Create the socket connection
    const sock = makeWASocket({
        version,
        logger: logger, // Pass our custom logger instance
        auth: state,
        printQRInTerminal: true, // Display QR code in the terminal
        // Add more config options here later (e.g., browser details)
    });

    // Event handler for saving credentials (essential for re-login)
    sock.ev.on('creds.update', saveCreds);

    // Event handler for connection state changes (essential for keeping the bot alive)
    sock.ev.on('connection.update', (update) => {
        const { connection, lastDisconnect, qr } = update;

        if (connection === 'close') {
            const shouldReconnect = (lastDisconnect.error instanceof Boom)
                ? lastDisconnect.error.output.statusCode !== DisconnectReason.loggedOut
                : true;

            logger.error(`Connection closed. Reason: ${lastDisconnect.error.message}, Reconnecting: ${shouldReconnect}`);

            // Reconnect if the session was not deliberately logged out
            if (shouldReconnect) {
                startBaileysBot(); // Restart the connection function
            }
        } else if (connection === 'open') {
            logger.info('Connection established successfully!');
        }

        // Display QR code if available for initial login
        if (qr) {
            logger.info('Scan the QR code in your terminal using WhatsApp Linked Devices.');
        }
    });

    return sock;
}

startBaileysBot();</code></pre>
            </div>
            
            <script>
                function copyCode(elementId) {
                    const codeElement = document.getElementById(elementId);
                    const codeText = codeElement.textContent || codeElement.innerText;
                    
                    navigator.clipboard.writeText(codeText).then(function() {
                        alert('Code copied to clipboard!');
                    }, function(err) {
                        console.error('Could not copy text: ', err);
                    });
                }
            </script>

            <hr>

            <h1>Explaining the Developer's Blueprint (Code Line-by-Line) üõ†Ô∏è</h1>
            <p>
                Do not worry about the complexity! We will explain the code line by line, defining its purpose and why it is absolutely necessary for a stable bot.
            </p>

            <h3>1. The Imports (Bringing Tools to the Workshop)</h3>
            <pre><code>import makeWASocket, { useMultiFileAuthState, fetchLatestBaileysVersion, DisconnectReason } from 'baileys-z';</code></pre>
            <p>
                This line is the entry point. It imports the main functions needed to connect and manage your bot's state from the <strong>Baileys-z</strong> library:
                <ul>
                    <li>
                        <strong><code>makeWASocket</code>:</strong> The <strong>primary function</strong> used to create a new WhatsApp WebSocket connection (the "socket").
                    </li>
                    <li>
                        <strong><code>useMultiFileAuthState</code>:</strong> The utility that helps you save your <strong>login credentials</strong> (session data) to the hard drive, allowing your bot to restart without rescanning the QR code every time.
                    </li>
                    <li>
                        <strong><code>fetchLatestBaileysVersion</code>:</strong> A function to get the <strong>latest stable WhatsApp protocol version</strong>. This ensures your bot connects with the most compatible settings.
                    </li>
                    <li>
                        <strong><code>DisconnectReason</code>:</strong> A list of constants that explains <strong>WHY</strong> the connection closed (e.g., logged out, internet failure, restart required). Essential for smart reconnection logic.
                    </li>
                </ul>
            </p>

            <pre><code>import { Boom } from '@hapi/boom';</code></pre>
            <p>
                <strong><code>Boom</code></strong> is a utility class used by Baileys-z for advanced <strong>HTTP-style error handling</strong>. We use it to check the type of error that caused a disconnection, which is crucial for determining if we should try to reconnect or if the session is permanently logged out.
            </p>

            <pre><code>import logger from './logger.js';</code></pre>
            <p>
                This is the import for your custom <strong>Ernest Tech House Logger</strong>. By exporting an instance of the logger from <code>./logger.js</code>, you ensure consistent, centralized, and clear logging across your entire application. This is a <strong>best practice</strong> for clean code and easy debugging!
            </p>

            <h3>2. The Connection Core (Setting up the Heartbeat)</h3>
            <pre><code>async function startBaileysBot() { ... }</code></pre>
            <p>
                We wrap our main logic in an `async` function. This is standard practice in Node.js, as most of the connection process involves waiting for network operations (<strong>promises</strong>) to complete.
            </p>

            <pre><code>const { state, saveCreds } = await useMultiFileAuthState('auth_info_baileys');</code></pre>
            <p>
                This is where the <strong>magic of persistence</strong> happens!
                <ul>
                    <li>
                        It loads the previous session state from the folder named `'auth_info_baileys'`.
                    </li>
                    <li>
                        It returns two things: <strong><code>state</code></strong> (the credentials to use for the current connection attempt) and <strong><code>saveCreds</code></strong> (a function that MUST be called whenever the credentials change).
                    </li>
                </ul>
            </p>

            <pre><code>const { version, isLatest } = await fetchLatestBaileysVersion();
logger.info(`Using WhatsApp version: ${version.join('.')}, is latest: ${isLatest}`);</code></pre>
            <p>
                We fetch the recommended WhatsApp version. We then use our custom `logger` to proudly announce which version of the protocol our bot is running on!
            </p>

            <pre><code>const sock = makeWASocket({
    version,
    logger: logger, 
    auth: state,
    printQRInTerminal: true, 
    // ...
});</code></pre>
            <p>
                We create the <strong>main connection object (`sock`)</strong>, passing in the crucial configuration:
                <ul>
                    <li>
                        <strong>`version`:</strong> Ensures we use the correct WhatsApp protocol version.
                    </li>
                    <li>
                        <strong>`logger`:</strong> Directs all Baileys-z internal logs to your <strong>`ernest-logger`</strong> instance.
                    </li>
                    <li>
                        <strong>`auth`:</strong> Provides the loaded session <strong>`state`</strong> (credentials) to the socket.
                    </li>
                    <li>
                        <strong>`printQRInTerminal`:</strong> Instructs the library to generate and display the QR code directly in the console for the initial login.
                    </li>
                </ul>
            </p>

            <h3>3. Event Handlers (Keeping the Bot Alive)</h3>
            <p>
                The `sock.ev.on(...)` lines are like the bot's nervous system. They listen for specific events (`ev`) that the WhatsApp connection fires.
            </p>

            <pre><code>sock.ev.on('creds.update', saveCreds);</code></pre>
            <p>
                This is the <strong>most vital line for permanence</strong>! Every time WhatsApp changes the encryption keys or credentials (which happens often), this event fires. We immediately call the <strong>`saveCreds`</strong> function we got earlier, writing the new state to disk. Without this, your bot would log out every few hours!
            </p>

            <pre><code>sock.ev.on('connection.update', (update) => { ... });</code></pre>
            <p>
                This is the <strong>heartbeat</strong> of the bot. This event fires whenever the connection status changes (e.g., connecting, open, closed). The logic inside ensures your bot is <strong>self-healing</strong>:
                <ul>
                    <li>
                        <strong>Connection Closed (<code>if (connection === 'close')</code>):</strong> It checks if the disconnection was intentional (like being manually logged out from the phone) or temporary (like an internet dropout).
                    </li>
                    <li>
                        <strong>Reconnection Logic:</strong> If the error is <em>not</em> a permanent `loggedOut` reason, it calls `startBaileysBot()` again, ensuring the bot attempts to reconnect automatically. This is essential for reliability.
                    </li>
                    <li>
                        <strong>Connection Open (<code>else if (connection === 'open')</code>):</strong> The bot is officially ready! The `logger` confirms the successful connection.
                    </li>
                    <li>
                        <strong>QR Code (<code>if (qr)</code>)</strong>: If a new login is needed, the `qr` string is generated, and the user is prompted to scan it.
                    </li>
                </ul>
            </p>

            <pre><code>startBaileysBot();</code></pre>
            <p>
                This is the final line that calls the main function, putting the entire connection process into action.
            </p>

            <hr>

            <p>
                The next step will be to create the supporting files: the <strong><code>logger.js</code></strong> for clean logs and the <strong><code>config.js</code></strong> to manage settings like API keys or default prefixes.
            </p>

            <div class="navigation-buttons">
                <button>
                    <a href="./config.html">Next: Setup Logger & Config(coming soon be patient)</a>
                </button>
                <button>
                    <a href="./instalation.html">Previous: Installation</a>
                </button>
            </div>
        </main>

        <footer>
            <div class="footer-content">
                <h3 style="color: #daa520; margin-bottom: 15px;">Ernest Tech House</h3>
                <p><strong>Maintained by:</strong> Pease Ernest</p>
                
                <div class="footer-links">
                    <p><strong>Contact & Resources</strong></p>
                    <p>
                        <a href="mailto:peaseearnest@example.com">üìß Email</a> |
                        <a href="https://github.com/peaseernest/baileys-z" target="_blank">üíª GitHub Repository</a> |
                        <a href="https://wa.me/254793859108" target="_blank">üì± WhatsApp: +254793859108</a>
                    </p>
                </div>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #8b6914;">
                    <p style="font-size: 0.9em; color: #b8860b;">
                        ¬© 2024 Ernest Tech House | Baileys-z Documentation
                    </p>
                    <p style="font-size: 0.85em; color: #8b6914; margin-top: 5px;">
                        This is an unofficial WhatsApp automation library. Use responsibly.
                    </p>
                </div>
            </div>
        </footer>

        <script src="" async defer></script>
    </body>
</html>